(function(e){function t(t,n,r){var i,s,o=t.width,u=t.width,a,f;f=e(t.parentNode);this.element=i=f.append("<canvas class='reflection' style='position:absolute'/>").find(":last")[0];if(!i.getContext&&e.browser.msie){this.element=i=f.append("<img class='reflection' style='position:absolute'/>").find(":last")[0];i.src=t.src;i.style.filter="flipv progid:DXImageTransform.Microsoft.Alpha(opacity="+r*100+", style=1, finishOpacity=0, startx=0, starty=0, finishx=0, finishy="+n/u*100+")"}else{s=i.getContext("2d");try{e(i).attr({width:o,height:n});s.save();s.translate(0,u-1);s.scale(1,-1);s.drawImage(t,0,0,o,u);s.restore();s.globalCompositeOperation="destination-out";a=s.createLinearGradient(0,0,0,n);a.addColorStop(0,"rgba(255, 255, 255, "+(1-r)+")");a.addColorStop(1,"rgba(255, 255, 255, 1.0)");s.fillStyle=a;s.fillRect(0,0,o,n)}catch(l){return}}e(i).attr({alt:e(t).attr("alt"),title:e(t).attr("title")})}var n=function(n,r){this.orgWidth=n.width;this.orgHeight=n.height;this.image=n;this.reflection=null;this.alt=n.alt;this.title=n.title;this.imageOK=false;this.options=r;this.imageOK=true;if(this.options.reflHeight>0){this.reflection=new t(this.image,this.options.reflHeight,this.options.reflOpacity)}e(this.image).css("position","absolute")};var r=function(t,r,i){var s=[],o=Math.sin,u=Math.cos,a=this;this.controlTimer=0;this.stopped=false;this.container=t;this.xRadius=i.xRadius;this.yRadius=i.yRadius;this.showFrontTextTimer=0;this.autoRotateTimer=0;if(i.xRadius===0){this.xRadius=e(t).width()/2.3}if(i.yRadius===0){this.yRadius=e(t).height()/6}this.xCentre=i.xPos;this.yCentre=i.yPos;this.frontIndex=0;this.rotation=this.destRotation=Math.PI/2;this.timeDelay=1e3/i.FPS;if(i.altBox!==null){e(i.altBox).css("display","block");e(i.titleBox).css("display","block")}e(t).css({position:"relative",overflow:"hidden"});e(i.buttonLeft).css("display","inline");e(i.buttonRight).css("display","inline");e(i.buttonLeft).bind("mouseup",this,function(e){e.data.rotate(-1);return false});e(i.buttonRight).bind("mouseup",this,function(e){e.data.rotate(1);return false});if(i.mouseWheel){e(t).bind("mousewheel",this,function(e,t){e.data.rotate(t);return false})}e(t).bind("click",this,function(t){clearInterval(t.data.autoRotateTimer);var n=e(t.target).attr("alt");if(n!==undefined&&n!==null){clearTimeout(t.data.showFrontTextTimer);e(i.altBox).html(e(t.target).attr("alt"));e(i.titleBox).html(e(t.target).attr("title"));if(i.bringToFront&&t.type=="click"){var s=e(t.target).data("itemIndex");var o=t.data.frontIndex;var u=(s-o)%r.length;if(Math.abs(u)>r.length/2){u+=u>0?-r.length:r.length}t.data.rotate(-u)}}});e(t).bind("mouseout",this,function(e){var t=e.data;clearTimeout(t.showFrontTextTimer);t.showFrontTextTimer=setTimeout(function(){t.showFrontText()},1e3);t.autoRotate()});e(t).bind("mousedown",this,function(e){e.data.container.focus();return false});t.onselectstart=function(){return false};this.innerWrapper=e(t).wrapInner('<div style="position:absolute;width:100%;height:100%;"/>').children()[0];this.showFrontText=function(){var t=(this.frontIndex+s.length)%s.length;if(s[t]===undefined){return}e(i.titleBox).html(e(s[t].image).attr("title"));e(i.altBox).html(e(s[t].image).attr("alt"))};this.go=function(){if(this.controlTimer!==0){return}var e=this;this.controlTimer=setTimeout(function(){e.updateAll()},this.timeDelay)};this.stop=function(){clearTimeout(this.controlTimer);this.controlTimer=0};this.rotate=function(e){this.frontIndex-=e;this.frontIndex%=s.length;this.destRotation+=Math.PI/s.length*2*e;this.showFrontText();this.go()};this.autoRotate=function(){if(i.autoRotate!=="no"){var e=i.autoRotate==="right"?1:-1;this.autoRotateTimer=setInterval(function(){a.rotate(e)},i.autoRotateDelay)}};this.updateAll=function(){var t=i.minScale;var n=(1-t)*.5;var r,a,f,l,c,h,p;var d=this.destRotation-this.rotation;var v=Math.abs(d);this.rotation+=d*i.speed;if(v<.001){this.rotation=this.destRotation}var m=s.length;var g=Math.PI/m*2;var y=this.rotation;var b=e.browser.msie;this.innerWrapper.style.display="none";var w;var E="px",S;var x=this;for(var T=0;T<m;T++){h=s[T];p=o(y);c=(p+1)*n+t;f=this.xCentre+(u(y)*this.xRadius-h.orgWidth*.5)*c;l=this.yCentre+p*this.yRadius*c;if(h.imageOK){var N=h.image;r=N.width=h.orgWidth*c;a=N.height=h.orgHeight*c;N.style.left=f+E;N.style.top=l+E;N.style.zIndex=""+c*100>>0;if(h.reflection!==null){S=i.reflHeight*c;w=h.reflection.element.style;w.left=f+E;w.top=l+a+i.reflGap*c+E;w.width=r+E;if(b){w.filter.finishy=S/a*100}else{w.height=S+E}}}y+=g}this.innerWrapper.style.display="block";if(v>=.001){this.controlTimer=setTimeout(function(){x.updateAll()},this.timeDelay)}else{this.stop()}e(this.container).trigger("cloudUpdateAll")};this.checkImagesLoaded=function(){var t;for(t=0;t<r.length;t++){if(r[t].width===undefined||r[t].complete!==undefined&&!r[t].complete){return}}for(t=0;t<r.length;t++){s.push(new n(r[t],i));e(r[t]).data("itemIndex",t)}clearInterval(this.tt);this.showFrontText();this.autoRotate();this.updateAll();e(this.container).trigger("cloudLoaded")};this.tt=setInterval(function(){a.checkImagesLoaded()},50)};e.fn.CloudCarousel=function(t){this.each(function(){t=e.extend({},{reflHeight:0,reflOpacity:.5,reflGap:0,minScale:.5,xPos:0,yPos:0,xRadius:0,yRadius:0,altBox:null,titleBox:null,FPS:30,autoRotate:"no",autoRotateDelay:1500,speed:.2,mouseWheel:false,bringToFront:false},t);e(this).data("cloudcarousel",new r(this,e(".cloudcarousel",e(this)),t))});return this}})(jQuery)